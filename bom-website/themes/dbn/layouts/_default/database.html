{{ define "main" }}
<body>  
    <div class="container mx-auto w-full h-full" x-data="billsData">
      
      <!-- Initialization loading screen -->
      <div x-show="!initialized" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex items-center justify-center">
        <div class="text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <div class="text-lg font-medium text-gray-700 mb-2">Loading Database</div>
          <div class="text-sm text-gray-500" x-text="{
            'starting': 'Initializing application...',
            'parsing': 'Parsing parameters...',
            'loading_static': 'Loading configuration...',
            'setting_up': 'Setting up interface...',
            'ready': 'Ready!',
            'error': 'Initialization failed'
          }[initializationStage] || 'Loading...'"></div>
        </div>
      </div>
      <!-- Global loading indicator -->
      <div x-show="meta.loading" class="fixed top-4 right-4 z-50 bg-white shadow-lg rounded-lg p-3 border border-gray-200" 
           x-transition:enter="transition ease-out duration-300" 
           x-transition:enter-start="opacity-0 transform translate-x-full" 
           x-transition:enter-end="opacity-100 transform translate-x-0" 
           x-transition:leave="transition ease-in duration-200" 
           x-transition:leave-start="opacity-100 transform translate-x-0" 
           x-transition:leave-end="opacity-0 transform translate-x-full">
        <div class="flex items-center space-x-3">
          <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
          <div class="text-sm text-gray-700">
            <span x-show="!meta.slowConnection">Loading data...</span>
            <span x-show="meta.slowConnection" class="text-amber-600">Connection is slow...</span>
          </div>
        </div>
      </div>
      
      <h2 class="text-4xl font-medium pt-4">{{ .Title }}</h2>

      {{ partial "tables/instructions.html" }}

      {{/* begin: two-tiered tab switcher */}}
      <div class="flex flex-wrap">
        <div class="w-full px-12 py-8">
          {{/* Primary tier tabs */}}
          <div class="border-b border-gray-200 mb-6">
            <nav class="flex justify-between items-center" aria-label="Primary tabs">
              <div class="flex space-x-8">
                <button
                  class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200"
                  :class="{ 
                    'border-blue-500 text-blue-600': getPrimaryTab() === 'annual', 
                    'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': getPrimaryTab() !== 'annual' 
                  }"
                  @click="setPrimaryTab('annual')"
                  type="button"
                >
                  Annual Data
                </button>
                <button
                  class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200"
                  :class="{ 
                    'border-blue-500 text-blue-600': getPrimaryTab() === 'yearly', 
                    'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': getPrimaryTab() !== 'yearly' 
                  }"
                  @click="setPrimaryTab('yearly')"
                  type="button"
                >
                  Yearly Data
                </button>
                <!-- Temporarily hidden: Bread and Death tab -->
                <!--
                <button
                  class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200"
                  :class="{ 
                    'border-blue-500 text-blue-600': getPrimaryTab() === 'bread-death', 
                    'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': getPrimaryTab() !== 'bread-death' 
                  }"
                  @click="setPrimaryTab('bread-death')"
                  type="button"
                >
                  Bread and Death
                </button>
                -->
              </div>
              <div 
                class="text-xs font-bold uppercase px-1 py-3 m-0.5 leading-normal text-black hover:underline cursor-pointer"
                @click="instructionsOpen = true"
              >
                How to use this table
              </div>
            </nav>
          </div>

          {{/* Primary tab descriptions */}}
          <div class="mb-6">
            <div x-show="getPrimaryTab() === 'annual'">
              <p class="text-sm text-gray-700">
                These are weekly bills of mortality published throughout the year, providing detailed week-by-week records. <a href="https://deathbynumbers.org/context/the-london-bills-of-mortality/">Learn more about the bills</a>.
              </p>
            </div>
            <div x-show="getPrimaryTab() === 'yearly'">
              <p class="text-sm text-gray-700">
                These are general bills of mortality published annually, summarizing yearly totals and providing broader statistical overviews. <a href="https://deathbynumbers.org/context/the-london-bills-of-mortality/">Learn more about the bills</a>.
              </p>
            </div>
          </div>

          {{/* Secondary tier tabs - Annual Data */}}
          <div x-show="getPrimaryTab() === 'annual'" class="mb-4">
            <div class="flex items-center justify-between">
              <nav class="flex space-x-4" aria-label="Annual data tabs">
              <button
                class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-colors duration-200"
                :class="{ 
                  'bg-blue-100 text-blue-700': getSecondaryTab() === 'parishes', 
                  'bg-gray-100 text-gray-600 hover:bg-gray-200': getSecondaryTab() !== 'parishes' 
                }"
                @click="setSecondaryTab('parishes')"
                type="button"
              >
                Parishes
              </button>
              <button
                class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-colors duration-200"
                :class="{ 
                  'bg-blue-100 text-blue-700': getSecondaryTab() === 'deaths', 
                  'bg-gray-100 text-gray-600 hover:bg-gray-200': getSecondaryTab() !== 'deaths' 
                }"
                @click="setSecondaryTab('deaths')"
                type="button"
              >
                Deaths
              </button>
              <button
                class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-colors duration-200"
                :class="{ 
                  'bg-blue-100 text-blue-700': getSecondaryTab() === 'christenings', 
                  'bg-gray-100 text-gray-600 hover:bg-gray-200': getSecondaryTab() !== 'christenings' 
                }"
                @click="setSecondaryTab('christenings')"
                type="button"
              >
                Christenings
              </button>
            </nav>
            <button 
              @click="filtersOpen = true"
              class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
              type="button">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"/>
              </svg>
              Filters
            </button>
          </div>
        </div>

          {{/* Secondary tier tabs - Yearly Data */}}
          <div x-show="getPrimaryTab() === 'yearly'" class="mb-4">
            <div class="flex items-center justify-between">
              <nav class="flex space-x-4" aria-label="Yearly data tabs">
              <button
                class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-colors duration-200"
                :class="{ 
                  'bg-blue-100 text-blue-700': getSecondaryTab() === 'parishes', 
                  'bg-gray-100 text-gray-600 hover:bg-gray-200': getSecondaryTab() !== 'parishes' 
                }"
                @click="setSecondaryTab('parishes')"
                type="button"
              >
                Parishes
              </button>
              <button
                class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-colors duration-200"
                :class="{ 
                  'bg-blue-100 text-blue-700': getSecondaryTab() === 'deaths', 
                  'bg-gray-100 text-gray-600 hover:bg-gray-200': getSecondaryTab() !== 'deaths' 
                }"
                @click="setSecondaryTab('deaths')"
                type="button"
              >
                Deaths
              </button>
              <button
                class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-colors duration-200"
                :class="{ 
                  'bg-blue-100 text-blue-700': getSecondaryTab() === 'christenings', 
                  'bg-gray-100 text-gray-600 hover:bg-gray-200': getSecondaryTab() !== 'christenings' 
                }"
                @click="setSecondaryTab('christenings')"
                type="button"
              >
                Christenings
              </button>
            </nav>
            <button 
              @click="filtersOpen = true"
              class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
              type="button">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"/>
              </svg>
              Filters
            </button>
          </div>
        </div>

          {{/* Secondary tier tabs - Bread and Death */}}
          <div x-show="getPrimaryTab() === 'bread-death'" class="mb-4">
            <div class="flex items-center justify-between">
              <nav class="flex space-x-4" aria-label="Bread and death tabs">
              <button
                class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-colors duration-200"
                :class="{ 
                  'bg-blue-100 text-blue-700': getSecondaryTab() === 'foodstuffs', 
                  'bg-gray-100 text-gray-600 hover:bg-gray-200': getSecondaryTab() !== 'foodstuffs' 
                }"
                @click="setSecondaryTab('foodstuffs')"
                type="button"
              >
                Foodstuffs
              </button>
              <button
                class="px-4 py-2 text-xs font-bold uppercase rounded-lg transition-colors duration-200"
                :class="{ 
                  'bg-blue-100 text-blue-700': getSecondaryTab() === 'ages', 
                  'bg-gray-100 text-gray-600 hover:bg-gray-200': getSecondaryTab() !== 'ages' 
                }"
                @click="setSecondaryTab('ages')"
                type="button"
              >
                Ages
              </button>
            </nav>
            <button 
              @click="filtersOpen = true"
              class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
              type="button">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"/>
              </svg>
              Filters
            </button>
          </div>
        </div>

          {{/* Tab content - Annual Data */}}
          <div x-show="getPrimaryTab() === 'annual' && getSecondaryTab() === 'parishes' && initialized">
            {{ partial "tables/weekly.html" }}
          </div>
          <div x-show="getPrimaryTab() === 'annual' && getSecondaryTab() === 'deaths' && initialized">
            {{ partial "tables/deaths.html" }}
          </div>
          <div x-show="getPrimaryTab() === 'annual' && getSecondaryTab() === 'christenings' && initialized">
            {{ partial "tables/christenings.html" }}
          </div>

          {{/* Tab content - Yearly Data */}}
          <div x-show="getPrimaryTab() === 'yearly' && getSecondaryTab() === 'parishes' && initialized">
            {{ partial "tables/general.html" }}
          </div>
          <div x-show="getPrimaryTab() === 'yearly' && getSecondaryTab() === 'deaths' && initialized">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
              <div class="mb-4">
                <img src="/images/missing.png" alt="Data unavailable" class="w-12 h-12 mx-auto rounded-full">
              </div>
              <h3 class="text-lg font-medium text-blue-900 mb-2">Data Currently Unavailable</h3>
              <p class="text-blue-700 mb-4">
                Yearly death data is not currently part of our dataset. We are working to include this information in future updates.
              </p>
              <p class="text-sm text-blue-600">
                Please check back in the future or explore our other data categories in the meantime.
              </p>
            </div>
          </div>
          <div x-show="getPrimaryTab() === 'yearly' && getSecondaryTab() === 'christenings' && initialized">
            {{ partial "tables/christenings.html" }}
          </div>

          {{/* Tab content - Bread and Death */}}
          <div x-show="getPrimaryTab() === 'bread-death' && getSecondaryTab() === 'foodstuffs' && initialized">
            <div class="bg-gray-50 rounded-lg p-6 text-center">
              <p class="text-gray-600">Foodstuffs data view - to be implemented</p>
            </div>
          </div>
          <div x-show="getPrimaryTab() === 'bread-death' && getSecondaryTab() === 'ages' && initialized">
            <div class="bg-gray-50 rounded-lg p-6 text-center">
              <p class="text-gray-600">Ages data view - to be implemented</p>
            </div>
          </div>
        </div>
      </div>
      {{/* end: tab switcher */}}

      {{/* Slide-out filter panel */}}
      <div 
        x-show="filtersOpen"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black bg-opacity-50 z-40"
        @click="filtersOpen = false">
      </div>
      
      <div 
        x-show="filtersOpen"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform translate-x-full"
        x-transition:enter-end="transform translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform translate-x-0"
        x-transition:leave-end="transform translate-x-full"
        class="fixed top-0 right-0 h-full w-96 bg-white shadow-xl z-50 overflow-y-auto"
        @click.stop>
        
        {{/* Filter panel header */}}
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
          <h2 class="text-lg font-medium text-gray-900">Filters</h2>
          <button 
            @click="filtersOpen = false"
            class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors duration-200">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        {{/* Filter content */}}
        {{ partial "tables/filter.html" }}
      </div>

      {{ $paths := slice "js/database.cacheservice.js" "js/database.urlservice.js" "js/database.dataservice.js" "js/database.chartservice.js" "js/database.alpine.js" "js/app-initializer.js" }}

      {{ $jsFiles := slice }}
      {{ range $paths }}
        {{ $resource := resources.Get . }}
        {{ if $resource }}
          {{ $jsFiles = $jsFiles | append $resource }}
        {{ end }}
      {{ end }}

      {{ if gt (len $jsFiles) 0 }}
        {{ $bundleJS := $jsFiles | resources.Concat "js/bills-bundle.js" | js.Build (dict "targetPath" "js/bills-bundle.js" "minify" true) }}
        {{ $secureJS := $bundleJS | resources.Fingerprint "sha512" }}
        <script src="{{ $secureJS.RelPermalink }}" integrity="{{ $secureJS.Data.Integrity }}"></script>
      {{ else }}
        <!-- No JS files found -->
        <script>console.error("No JS files found to bundle");</script>
      {{ end }}
    </div>
  </body>
{{ end }}
